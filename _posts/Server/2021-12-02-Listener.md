---
layout: single
title: "C# Rookiss Part4 ê²Œì„ì„œë²„ : Listener"
categories: Server
tags: Server
author_profile: false
sidebar:
  nav: "docs"
---

## ğŸ™‡â€â™€ï¸Listener

ë¬¸ì§€ê¸°ë¥¼ ë”°ë¡œ ë¹¼ì!

* Accept, Receive, Send ë“± ëª¨ë“  ì…ì¶œë ¥ í•¨ìˆ˜ë“¤ì€ ë¹„ë™ê¸° ë°©ì‹ìœ¼ë¡œ í•´ì•¼ ë¨
* ì¼ë‹¨ ì˜ˆì•½ì„ í•´ë†“ê³  ì†ë‹˜ì´ ë“¤ì–´ì˜¤ë©´ ì‘ë™í•˜ê²Œ ë” ë§Œë“¤ê¸° (ì´ë²¤íŠ¸ ë°©ì‹)

* ë‚šì‹œ ì˜ˆì‹œ
  * ì²˜ìŒì—ëŠ” ë‚šì‹œëŒ€ë¥¼ ì§ì ‘ ë˜ì§€ê¸°
  * ì…ì§ˆì´ ë°”ë¡œ ì˜¤ë©´ ë°”ë¡œ í• ì¼í•˜ê¸°
  * ì…ì§ˆì´ ì•ˆì˜¤ë©´ ì˜¬ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ë‹¤ê°€ ì˜¤ë©´ í• ì¼í•˜ê¸°
  * í• ì¼ì´ ëë‚¬ìœ¼ë©´ ë‹¤ì‹œ ë‚šì‹œëŒ€ ë˜ì§€ê¸°

ServerCoreëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ë°”ë€œ

**`args.Completed += new EventHandler<SocketAsyncEventArgs>(OnAccepteCompleted);`** ì˜ ëª¨ë¥´ëŠ” ë¶€ë¶„
=> ê·¸ëƒ¥ ì´ë ‡ê²Œ ì“°ëŠ”ê±´ê°‘ë‹¤ í•´ì•¼ë¨
  
ê²Œì„ì—ëŠ” ë¹„ë™ê¸°í•¨ìˆ˜ë¥¼ ì¨ì•¼í•œë‹¤ - Accept => AcceptAsync

Asyncê³„ì—´ì˜ í•¨ìˆ˜ë“¤ì€ ê·¸ í–‰ë™ì„ í–ˆë“  ì•ˆí–ˆë“  ì¼ë‹¨ ë¦¬í„´ì„ í•¨
-> ì¼ì„ ì•ˆí–ˆì„ ë• ì¼ë‹¨ ë¹ ì ¸ë‚˜ê°”ìœ¼ë‹ˆê¹Œ ë‹¤ì‹œ ì•Œë ¤ì¤˜ì•¼í•¨ ( ì´ë²¤íŠ¸ ë°©ì‹)
ì¼ì„ ìš”ì²­í•˜ëŠ” ë¶€ë¶„ê³¼ ì‹¤ì œ ì¼ì„ í•˜ëŠ” ë¶€ë¶„ìœ¼ë¡œ ë‚˜ë‰œë‹¤ - RegisterAccept, OnAcceptCompleted

pending = ë¯¸ê²°ì •ì˜
pending == false ì‹¤í–‰ê³¼ ê±°ì˜ ë™ì‹œì— í´ë¼ì—ì„œ ì ‘ì†ì´ ì˜¨ ê²½ìš°

args.Completed ëŠ” EventHandlerë°©ì‹ìœ¼ë¡œ ì´ë²¤íŠ¸ ë°©ì‹ìœ¼ë¡œ ì½œë²¡ìœ¼ë¡œ ì „ë‹¬í•˜ëŠ” ë°©ì‹

Action<Socket> _onAcceptHandlerë¥¼ ë§Œë“  ì´ìœ  - Acceptë¥¼ í•œ ì´ìœ ì˜ í–‰ë™ë“¤ì„ ì´ë²¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ë°›ì•„ì„œ ì†Œì¼“ì´ ê·¸ ì¼ì„ í•˜ê²Œ ë§Œë“¤ê¸° ìœ„í•˜ì—¬, _onAcceptHandler.Invoke(args.AcceptSocket);ì´ ë˜ëŠ” ê²ƒ!, args.AcceptSocketì€ argsê°€ AcceptAsyncë¥¼ í–ˆê¸° ë•Œë¬¸ì— ê°€ì§„ Socketì´ë¼ê³  ìƒê°í•˜ë©´ ë ë“¯

Asyncê³„ì—´ì˜ í•¨ìˆ˜ë“¤ì€ ë‹¹ì¥ì€ ê°’ì„ ë½‘ì•„ì˜¬ ìˆ˜ê°€ ì—†ê¸° ë•Œë¬¸ì— SocketAsyncEventArgsê°€ ì´ëŸ°ì €ëŸ° ì •ë³´ë“¤ì„ ê°€ì ¸ì™€ì„œ ì „ë‹¬í•´ì£¼ëŠ” ëŠë‚Œ

í”„ë¡œê·¸ë¨ì—ì„œ Socketì„ ì¸ìë¡œ ë°›ëŠ” í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ì„œ Init(IPEndPoint, Action<Socket>)ì— ë§ì¶°ì¤€ë‹¤

### ğŸªListenerë¶„ì„

```cs
class Listener
{
    Socket _listenSocket; // ë¦¬ìŠ¤ë„ˆ ì†Œì¼“ ìƒì„±
    Action<Socket> _onAcceptHandler; // ì´ë²¤íŠ¸ ë°©ì‹ìœ¼ë¡œ ì „ë‹¬

    public void Init(IPEndPoint endPoint, Action<Socket> onAcceptHandler) // ì´ë‹›í• ë•Œ ì´ë²¤íŠ¸ ì—°ê²°ê¹Œì§€ í•´ì¤Œ
    {
        // ë¬¸ì§€ê¸°
        _listenSocket = new Socket(endPoint.AddressFamily, SocketType.Stream, ProtocolType.Tcp); // ë¦¬ìŠ¤ë„ˆ ì†Œì¼“ ì—°ê²°
        _onAcceptHandler += onAcceptHandler; // ì´ë²¤íŠ¸ êµ¬ë… ì‹ ì²­

        // ë¬¸ì§€ê¸° êµìœ¡
        _listenSocket.Bind(endPoint); // ë°”ì¸ë“œ ê²°í•©

        // ì˜ì—… ì‹œì‘
        // BackLog : ìµœëŒ€ ëŒ€ê¸°ìˆ˜
        _listenSocket.Listen(10); // ì¼ê¾¼ ìˆ˜ ì„¤ì •

        SocketAsyncEventArgs args = new SocketAsyncEventArgs(); // ì´ë²¤íŠ¸ í˜•ì‹ ìš”ì • ìƒì„±
        args.Completed += new EventHandler<SocketAsyncEventArgs>(OnAcceptCompleted); // ì»´í”Œë¦¿ êµ¬ë… ì‹ ì²­
        RegisterAccept(args); // ì²« ë‚šì‹œëŒ€ ë˜ì§€ê¸°
    }

    void RegisterAccept(SocketAsyncEventArgs args) // ì–´ì…‰ ë“±ë¡í•˜ê¸° í•¨ìˆ˜, ì´ë²¤íŠ¸í•¸ë“¤ëŸ¬ ë•Œë§¤ SocketAsyncEventArgs args ì¸ìê°€ í•„ìš”
    {
        args.AcceptSocket = null; // ë‘ë²ˆì§¸ í„´ë¶€í„° ë‚¨ì•„ìˆëŠ” ê°’ìœ¼ë¡œ ì—ëŸ¬ë‚˜ê¸° ë•Œë¬¸ì— ì´ˆê¸°í™” ì‹œì¼œì£¼ê¸°

        bool pending = _listenSocket.AcceptAsync(args); // ë¹„ë™ê¸° í•¨ìˆ˜ë¡œ íŒ¬ë”© ìœ ë¬´í™•ì¸
        if (pending == false) // íŒ¬ë”©ì´ ì—†ë‹¤ëŠ” ê±´ ë‚šì‹œëŒ€ë¥¼ ë„£ìë§ˆì ë¬¼ê³ ê¸°ê°€ ë‚šì´ëŠ” ê²ƒ
            OnAcceptCompleted(null, args);
    }

    void OnAcceptCompleted(object sender, SocketAsyncEventArgs args) // ì´ë²¤íŠ¸í•¸ë“¤ëŸ¬ ë•Œë§¤ object sender, SocketAsyncEventArgs args ì¸ìê°€ í•„ìš”
    {
        if (args.SocketError == SocketError.Success) // ì—ëŸ¬ê°€ ì—†ì´ ì˜ ì„±ê³µí–ˆì„ ë•Œ
        {
            _onAcceptHandler.Invoke(args.AcceptSocket); // ì„œë²„ì½”ì–´ì— ìˆëŠ” ì¼ ì‹œí‚¤ê¸° (ì´ë²¤íŠ¸ ë°œì†¡)
        }
        else
            Console.WriteLine(args.SocketError.ToString()); // ë¬´ìŠ¨ ì—ëŸ¬ì¸ì§€ í™•ì¸í•˜ê¸°

        RegisterAccept(args); // ë‹¤ëë‚¬ìœ¼ë©´ ë‹¤ì‹œ ë‚šì‹œëŒ€ ë˜ì§€ê¸°
    }
}
```

`args.Completed += new EventHandler<SocketAsyncEventArgs>(OnAcceptCompleted); // ì–´ì‹±í¬ë¥¼ ë§Œë“¤ê³  ì–´ì‹±í¬ì•„ê·œë¨¼ì¸ ë¥¼ ë„£ì–´ì¤€ê²½ìš° ì½œë°±í•¨ìˆ˜ëŠ” ë³„ë„ì˜ ì“°ë ˆë“œê°€ ìƒì„±`

`void OnAcceptCompleted(object sender, SocketAsyncEventArgs args) // ë ˆë“œì¡´, ì“°ë ˆë“œë‚˜ í…ŒìŠ¤í¬ë¥¼ ë§Œë“¤ì§€ ì•Šì•˜ì§€ë§Œ ìë™ì ìœ¼ë¡œ í’€ì—ì„œ ìƒì„±í•´ì„œ ì‚¬ìš©í•¨`


### ğŸªListner, DummyClient, ServerCore ì „ì²´ ì½”ë“œ

* Listner
```cs
namespace ServerCore
{
    class Listener
    {
        Socket _listenSocket;
        Action<Socket> _onAcceptHandler;

        public void Init(IPEndPoint endPoint, Action<Socket> onAcceptHandler)
        {
            // ë¬¸ì§€ê¸°
            _listenSocket = new Socket(endPoint.AddressFamily, SocketType.Stream, ProtocolType.Tcp);
            _onAcceptHandler += onAcceptHandler;

            // ë¬¸ì§€ê¸° êµìœ¡
            _listenSocket.Bind(endPoint);

            // ì˜ì—… ì‹œì‘
            // BackLog : ìµœëŒ€ ëŒ€ê¸°ìˆ˜
            _listenSocket.Listen(10);

            SocketAsyncEventArgs args = new SocketAsyncEventArgs();
            args.Completed += new EventHandler<SocketAsyncEventArgs>(OnAcceptCompleted);
            RegisterAccept(args);
        }

        void RegisterAccept(SocketAsyncEventArgs args)
        {
            args.AcceptSocket = null;

            bool pending = _listenSocket.AcceptAsync(args);
            if (pending == false)
                OnAcceptCompleted(null, args);
        }

        void OnAcceptCompleted(object sender, SocketAsyncEventArgs args)
        {
            if (args.SocketError == SocketError.Success)
            {
                _onAcceptHandler.Invoke(args.AcceptSocket);
            }
            else
                Console.WriteLine(args.SocketError.ToString());

            RegisterAccept(args);
        }

        public Socket Accept()
        {
            
            return _listenSocket.Accept();
        }
    }
}
```

* DummyClient
```cs
namespace DummyClient
{
    class Program
    {
        static void Main(string[] args)
        {
            while (true)
            {
                // DNS (Domain Name System)
                string host = Dns.GetHostName();
                IPHostEntry ipHost = Dns.GetHostEntry(host);
                IPAddress ipAddr = ipHost.AddressList[0];
                IPEndPoint endPoint = new IPEndPoint(ipAddr, 7777);

                // íœ´ëŒ€í° ì„¤ì •
                Socket socket = new Socket(endPoint.AddressFamily, SocketType.Stream, ProtocolType.Tcp);

                try
                {
                    // ë¬¸ì§€ê¸°í•œí…Œ ì…ì¥ ë¬¸ì˜
                    socket.Connect(endPoint);
                    Console.WriteLine($"Connected to {socket.RemoteEndPoint.ToString()}");

                    // ë³´ë‚¸ë‹¤
                    byte[] sendBuff = Encoding.UTF8.GetBytes("Hello World!");
                    int sendBytes = socket.Send(sendBuff);

                    // ë°›ëŠ”ë‹¤
                    byte[] recvBuff = new byte[1024];
                    int recvBytes = socket.Receive(recvBuff);
                    string recvData = Encoding.UTF8.GetString(recvBuff, 0, recvBytes);
                    Console.WriteLine($"[From Server] {recvData}");

                    // ë‚˜ê°„ë‹¤
                    socket.Shutdown(SocketShutdown.Both);
                    socket.Close();
                }
                catch (Exception e)
                {
                    Console.WriteLine(e.ToString());
                }

                Thread.Sleep(500);
            }
        }
    }
}
```

* ServerCore
```cs
namespace ServerCore
{
    class Program
    {
        static Listener _listener = new Listener();

        static void OnAcceptHandler(Socket clientSocket)
        {
            try
            {
                // ë°›ëŠ”ë‹¤
                byte[] recvBuff = new byte[1024];
                int recvBytes = clientSocket.Receive(recvBuff);
                string recvData = Encoding.UTF8.GetString(recvBuff, 0, recvBytes);
                Console.WriteLine($"[From Client] {recvData}");

                // ë³´ë‚¸ë‹¤
                byte[] sendBuff = Encoding.UTF8.GetBytes("Welcome to MMORPG Server!");
                clientSocket.Send(sendBuff);

                // ì«“ì•„ë‚¸ë‹¤
                clientSocket.Shutdown(SocketShutdown.Both);
                clientSocket.Close();
            }
            catch (Exception e)
            {
                Console.WriteLine(e.ToString());
            }
        }

        static void Main(string[] args)
        {
            // DNS (Domain Name System)
            string host = Dns.GetHostName();
            IPHostEntry ipHost = Dns.GetHostEntry(host);
            IPAddress ipAddr = ipHost.AddressList[0];
            IPEndPoint endPoint = new IPEndPoint(ipAddr, 7777);

            _listener.Init(endPoint, OnAcceptHandler);

            Console.WriteLine("Listening...");
            while (true)
            {
                ;
            }

        }
    }
}
```
