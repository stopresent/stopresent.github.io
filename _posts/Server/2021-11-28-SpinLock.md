---
layout: single
title: "SpinLock"
categories: Server
tags: Server
author_profile: false
sidebar:
  nav: "docs"
---


## ğŸ™‡â€â™€ï¸SpinLock

í™”ì¥ì‹¤ì— ì‚¬ëŒì´ ìˆë‹¤ë©´ ë‚˜ì˜¬ ë•Œ ê¹Œì§€ ê¸°ë‹¤ë¦¬ê³  ìˆë‹¤ê°€ ë“¤ì–´ê°!


### ğŸªì›ìì„±ì˜ í•„ìš”

```cs
volatile bool _locked = false;

public void Acquire()
{
    while (_locked)
    {
        // ëˆ„êµ°ê°€ê°€ í’€ì–´ì£¼ê¸¸ ê¸°ë‹¤ë¦°ë‹¤
    }
    
    // ë‚´êº¼!
    _locked = true;
}

public void Release()
{
    _locked = false;
}
```

ìë¬¼ì‡ ë¥¼ ê±¸ê³  ë“¤ì–´ê°€ ì ê¸ˆì´ í’€ë¦¬ê¸°ê¹Œì§€ ê¸°ë‹¤ë¦¬ê³  ë‚´ê°€ ë“¤ì–´ê°€ë©´ ìë¬¼ì‡ ë¡œ ì ê·¼ë‹¤

ì‚¬ìš©ì„ ë‹¤í•˜ë©´ ìê¸ˆì„ í’€ê³  ë‚˜ê°„ë‹¤


ì–¸ëœ»ë³´ë©´ ìŠ¤í•€ë½ì´ ì˜ êµ¬í˜„ëœê²ƒ ê°™ì§€ë§Œ ì›í•˜ëŠ” ê²°ê³¼ëŠ” ì•ˆë‚˜ì˜¨ë‹¤

* ì´ìœ 
  * ë¬¸ì„ í’€ì–´ì£¼ê¸¸ ê¸°ë‹¤ë¦¬ëŠ” ë¶€ë¶„ê³¼ ë¬¸ì„ ì êµ¬ëŠ” ë¶€ë¶„ì´ ì›ìì ìœ¼ë¡œ ì²˜ë¦¬ ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸
  * í™”ì¥ì‹¤ì— ë‘ëª…ì´ ë™ì‹œì— ë“¤ì–´ê°€ì„œ ë¬¸ì„ ì ê·¸ëŠ” ìƒí™©ì´ ë°œìƒí•¨!
  * í™”ì¥ì‹¤ì— ë“¤ì–´ê°€ê³  ë¬¸ì„ ì êµ¬ëŠ” ê²ƒì€ ì›ìì ìœ¼ë¡œ ì²˜ë¦¬ í•´ì•¼ëœë‹¤!!


### ğŸªInterlocked.Exchange

```cs
volatile int _locked = 0;

public void Acquire()
{
    while (true)
    {
        int original = Interlocked.Exchange(ref _locked, 1);
        if (original == 0) // í™”ì¥ì‹¤ì— ì‚¬ëŒì´ ì—†ì—ˆë‹¤ë©´ originalì€ 0ì´ê³  _lockedì—ëŠ” 1ì´ ë“¤ì–´ê°
            break;
    }
}

public void Release()
{
    _locked = 0;
}
```

* `int original = Interlocked.Exchange(ref _locked, 1);`í•´ì„
  * `Interlocked.Exchange(ref _locked, 1)`ì€ _lockedì— 1ì„ ëŒ€ì…í•˜ëŠ”ê²ƒ
  * originalì€ _lockedì— 1ì„ ëŒ€ì…í•˜ê¸° ì „ ë“¤ì–´ìˆëŠ” ê°’
  * í™”ì¥ì‹¤ì— ë“¤ì–´ê°€ê³ ë¬¸ì„ ì ê·¸ëŠ” ê²ƒì´ ì›ìì ìœ¼ë¡œ ì²˜ë¦¬!

```cs
original = _locked;
_locked = 1;
if (original == 0)
    break;
```
ì›ìì ìœ¼ë¡œ ì²˜ë¦¬ëœ ë¶€ë¶„ì„ í’€ì–´ì“´ê²ƒ

### ğŸªInterlocked.CompareExchange

* CAD Compare - And - Swap ì—°ì‚°


```cs
// CAD Compare - And - Swap ì—°ì‚°

int expected = 0;
int desired = 1;
if (Interlocked.CompareExchange(ref _locked, desired, expected) == expected)
    break;
```

* `if (Interlocked.CompareExchange(ref _locked, desired, expected) == expected)` í•´ì„
  * _lockedê°€ expectedì™€ ê°™ìœ¼ë©´ desiredë¥¼ ëŒ€ì…í•˜ë¼
  * ë°˜í™˜ê°’ì€ _lockedì— ë“¤ì–´ìˆë˜ê°’
  * ë°˜í™˜ê°’(ì´ì „ê°’)ì´ expectedì™€ ê°™ìœ¼ë©´~~

ê°’ì„ ë¹„êµí›„ ê°™ìœ¼ë©´ ê°’ì„ ë°”ê¾¸ëŠ” ì—°ì‚°ë²•
CASì—°ì‚°! (Compare - And - Swap)

Interlocked.Exchangeë³´ë‹¤ ìì£¼ ì‚¬ìš©ëœë‹¤

### ğŸªInterlocked.CompareExchangeì„ ì‚¬ìš©í•œ ì „ì²´ì½”ë“œ

```cs
namespace ServerCore
{
    class SpinLock
    {
        volatile int _locked = 0;

        public void Acquire()
        {
            while (true)
            {
                // CAD Compare - And - Swap
                int expected = 0;
                int desired = 1;
                if (Interlocked.CompareExchange(ref _locked, desired, expected) == expected)
                    break;
            }
        }

        public void Release()
        {
            _locked = 0;
        }
    }

    class Program
    {
        static int _num = 0;
        static SpinLock _lock = new SpinLock();

        static void Thread_1()
        {
            for (int i = 0; i < 100000; i++)
            {
                _lock.Acquire();
                _num++;
                _lock.Release();
            }
        }

        static void Thread_2()
        {
            for (int i = 0; i < 100000; i++)
            {
                _lock.Acquire();
                _num--;
                _lock.Release();
            }
        }

        static void Main(string[] args)
        {
            Task t1 = new Task(Thread_1);
            Task t2 = new Task(Thread_2);

            t1.Start();
            t2.Start();

            Task.WaitAll(t1, t2);

            Console.WriteLine(_num);
        }
    }
}
```




