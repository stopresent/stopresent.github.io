---
layout: single
title: "Session"
categories: Server
tags: Server
author_profile: false
sidebar:
  nav: "docs"
---


## ğŸ™‡â€â™€ï¸Session

ì„¸ì…˜ ì¢…í•©ë³¸.

### ğŸªSession

```cs
namespace ServerCore
{
    abstract class Session
    {
        Socket _socket;
        int _disconnected = 0;

        object _lock = new object();
        Queue<byte[]> _sendQueue = new Queue<byte[]>();
        List<ArraySegment<byte>> _pendingList = new List<ArraySegment<byte>>();
        SocketAsyncEventArgs _sendArgs = new SocketAsyncEventArgs();
        SocketAsyncEventArgs _recvArgs = new SocketAsyncEventArgs();

        public abstract void OnConnected(EndPoint endPoint);
        public abstract void OnRecv(ArraySegment<byte> buffer);
        public abstract void OnSend(int numOfBytes);
        public abstract void OnDisconnected(EndPoint endPoint);

        public void Start(Socket socket)
        {
            _socket = socket;

            _recvArgs.Completed += new EventHandler<SocketAsyncEventArgs>(OnRecvCompleted);
            _recvArgs.SetBuffer(new byte[1024], 0, 1024);

            _sendArgs.Completed += new EventHandler<SocketAsyncEventArgs>(OnSendCompleted);

            RegisterRecv();
        }

        public void Send(byte[] sendBuff)
        {
            lock (_lock)
            {
                _sendQueue.Enqueue(sendBuff);
                if (_pendingList.Count == 0)
                    RegisterSend();
            }
        }

        public void Disconnect()
        {
            if (Interlocked.Exchange(ref _disconnected, 1) == 1)
                return;

            OnDisconnected(_socket.RemoteEndPoint);
            _socket.Shutdown(SocketShutdown.Both);
            _socket.Close();
        }

        #region ë„¤íŠ¸ì›Œí¬ í†µì‹ 

        void RegisterSend()
        {
            _pendingList.Clear();
            while (_sendQueue.Count > 0)
            {
                byte[] buff = _sendQueue.Dequeue();
                _pendingList.Add(new ArraySegment<byte>(buff, 0, buff.Length));
            }
            _sendArgs.BufferList = _pendingList;

            bool pending = _socket.SendAsync(_sendArgs);
            if (pending == false)
                OnSendCompleted(null, _sendArgs);
        }

        void OnSendCompleted(object sender, SocketAsyncEventArgs args)
        {
            lock (_lock)
            {
                if (args.BytesTransferred > 0 && args.SocketError == SocketError.Success)
                {
                    try
                    {
                        _sendArgs.BufferList = null;
                        _pendingList.Clear();

                        OnSend(_sendArgs.BytesTransferred);

                        if (_sendQueue.Count > 0)
                            RegisterSend();

                    }
                    catch (Exception e)
                    {
                        Console.WriteLine($"OnSendCompleted Failed {e}");
                    }
                }
                else
                {
                    // TODO DIsconnect
                    Disconnect();
                }
            }
        }

        void RegisterRecv()
        {
            bool pending = _socket.ReceiveAsync(_recvArgs);
            if (pending == false)
                OnRecvCompleted(null, _recvArgs);
        }

        void OnRecvCompleted(object sender, SocketAsyncEventArgs args)
        {

            if (args.BytesTransferred > 0 && args.SocketError == SocketError.Success)
            {
                try
                {
                    OnRecv(new ArraySegment<byte>(args.Buffer, args.Offset, args.BytesTransferred));
                    RegisterRecv();
                }
                catch (Exception e)
                {
                    Console.WriteLine($"OnRecvCompleted Failed {e}");
                }
            }
            else
            {
                Disconnect();
            }
        }

        #endregion
    }
}
```


### ğŸªë¶„ì„


* Session1 - Recv

  * SocketAsyncEventArgsëŠ” ë…ë¦½ì ì´ì—¬ì„œ ì—¬ëŸ¬ê°œë¥¼ ë§Œë“¤ë©´ ê°ìê°€ ì¼ì„ í•¨ - ì“°ë ˆë“œì²˜ëŸ¼ ìƒê°í•˜ë©´ ë ë“¯

  * Asyncê³„ì—´ì˜ í•¨ìˆ˜ë¥¼ ë§Œë“¤ê³  AsyncEventArgsë¥¼ ë„£ì–´ ì¤€ ê²½ìš° ì½œë°±í•¨ìˆ˜ëŠ” ë³„ë„ì˜ ì“°ë ˆë“œë¥¼ ë§Œë“ ë‹¤

  * Sessionìœ¼ë¡œ ë§Œë“  ë¶€ë¶„ì€ Receive, Send, Disconnect


* Session2 - Send

  * SendëŠ” ê·¸ ì‹œì ì— RegisterSendë¥¼ í•˜ê²Œ ë§Œë“¤ì–´ì¤Œ - SocketAsyncEventë¥¼ ìƒˆë¡œ ë§Œë“¤ì–´ ì£¼ê³  SetBufferë¥¼ í•œ í›„ RegitserSend 

  * => ì¬ì‚¬ìš© í•  ìˆ˜ ì—†ìŒ, ë¶€í•˜ê°€ í¼(ë„¤íŠ¸ì›Œí¬ ì†¡ìˆ˜ì‹  ë¶€ë¶„ì´ ë¶€í•˜ê°€ í¼), ìœ ì €ëª¨ë“œì—ì„œ ë„¤íŠ¸ì›Œí¬ íŒ¨í‚·ì„ ë³´ë‚´ëŠ” ê²ƒì˜ ë³´í†µ ë¶ˆê°€ëŠ¥í•˜ê³  ì´ëŸ°ê²ƒë“¤ì€ ìš´ì˜ì²´ì œê°€ ì»¤ë„ë‹¨ì—ì„œ í•¨ 

  * => SocketAsyncEventArgsë¥¼ ì¬ì‚¬ìš©í•˜ê³  ì‹¶ê³  ë°ì´í„°ë¥¼ ë­‰ì³ì„œ ë³´ë‚´ê³  ì‹¶ë‹¤!! ( SocketAsyncEventArgs )ë¥¼ ë°–ìœ¼ë¡œ ë¹¼ì

  * Queueë¥¼ ë§Œë“¤ì–´ì„œ ì°¨ê³¡ì°¨ê³¡ ìŒ“ì•„ì„œ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬ ë˜ê²Œ ë§Œë“¤ê¸° ( OnSendCompletedê°€ ëë‚˜ê¸° ì „ê¹Œì§€ ë³´ë‚´ì§€ ì•Šê³  Queueì— ìŒ“ê¸°) 

  * SendëŠ” ì–¸ì œ ì‚¬ìš©ë ì§€ ì˜ˆì¸¡ í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ë¯¸ë¦¬ ë§´ë²„ë³€ìˆ˜ë¡œ _sendArgsë¥¼ ë§Œë“¤ê³  ì‹¤ì œ ì‚¬ìš©ë  ë•Œ Registerì•ˆì—ì„œ _sendArgsë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ì‹, ë³´ë‚´ëŠ” ì‘ì—…ì´ ì™„ë£Œ ë˜ì§€ ì•Šì„ ë•Œ ëˆ„êµ°ê°€ê°€ ë³´ë‚´ëŠ” ì‘ì—…ì„ í•œë‹¤ë©´ ì¼ë‹¨ Queueì— ìŒ“ì•„ë‘ì—ˆë‹¤ê°€ ë‚˜ì¤‘ì— ì²˜ë¦¬


* Session3 - BufferList

  * BufferListì™€ SetBufferëŠ” ë™ì‹œì— ì‚¬ìš© ëª»í•¨ 

  * ArraySegment : ì–´ë–¤ Arrayì˜ ì¼ë¶€ë¥¼ ë°˜í™˜í•˜ëŠ” êµ¬ì¡°ì²´ - í™ì´ ì•„ë‹ˆë¼ ìŠ¤íƒì— í• ë‹¹ë¨
 
  * csì€ cppì™€ ë‹¬ë¦¬ í¬ì¸í„°ì˜ ê°œë…ì´ ì—†ê¸° ë•Œë¬¸ì— ì£¼ì†Œë¥¼ ë„˜ê¸°ëŠ”ê²Œ ì•„ë‹ˆë¼ ì¸ë±ìŠ¤ë¥¼ ë„˜ê¸°ê³  í¬ê¸°ë¥¼ ì •í•¨ - ex) new ArraySegment<byte> (buff, 0, buff.Length)

  
* Session4 - ì¶”ìƒí´ë˜ìŠ¤ë¥¼ ë§Œë“¤ê³  ì´ë²¤íŠ¸í˜•ì‹ìœ¼ë¡œ ì½œë°±í•˜ê¸°
  
  * abstract í´ë˜ìŠ¤ëŠ” ë§‰ë°”ë¡œ ì‚¬ìš© ëª»í•¨

  * ì½œë°±í˜•ì‹ì„ ì·¨í•˜ê¸° ìœ„í•´ Sessionì„ ìƒì†ë°›ì€ GameSessionì„ ë§Œë“¤ì–´ì„œ  ì¶”ìƒí´ë˜ìŠ¤ êµ¬í˜„

  * _sessionFactory ì„¸ì…˜ì„ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ëˆ„êµ¬ë¥¼ ë§Œë“¤ì–´ ì¤„ì§€ ì •ì˜í•˜ëŠ” Func( out ê²°ê³¼ê°’ì´ ìˆìŒ ) => ì„¸ì…˜ì„ ëˆ„êµ¬ë¥¼ ë§Œë“¤ì–´ì¤„ì§€ ì •ì˜í•˜ë©´ì„œ ì‚¬ìš©í•´ì•¼ ë¨ ( _listner.Init(endPoint, () => { return new GameSession(); }

  * ì»¨í…ì¸ ë‹¨ê³¼ ì—”ì§„ë‹¨ì„ êµ¬ë³„í•˜ê¸° ìœ„í•œ ì‘ì—…ë“¤!

  * -> Session session = _sessionFactory.Invoke(); ì‚¬ìš©ê°€ëŠ¥, ì–´ë–¤ ì„¸ì…˜ì„ ë§Œë“¤ì§€ ëª¨ë¥´ë‹ˆê¹Œ Sessionì„ ë±‰ëŠ” _sessionFactoryë¥¼ ë§Œë“ ê²ƒì´ í¬ì¸íŠ¸
