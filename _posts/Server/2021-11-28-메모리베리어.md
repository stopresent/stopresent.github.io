---
layout: single
title: "ë©”ëª¨ë¦¬ë² ë¦¬ì–´"
categories: Server
tags: Server
author_profile: false
sidebar:
  nav: "docs"
---

## ğŸ™‡â€â™€ï¸ë©”ëª¨ë¦¬ ë² ë¦¬ì–´

A) ì½”ë“œ ì¬ë°°ì¹˜ ì–µì œ
B) ê°€ì‹œì„±



### ğŸªí•˜ë“œì›¨ì–´ ìµœì í™”

í•˜ë“œì›¨ì–´ì—ì„œ ì½”ë“œì ìœ¼ë¡œ ì—°ê´€ì´ ì—†ë‹¤ë©´ ìµœì í™”ë¥¼ ìœ„í•´ ì½”ë“œë¥¼ ì¬ë°°ì¹˜ë¥¼í•œë‹¤


```cs
static int x = 0;
static int y = 0;
static int r1 = 0;
static int r2 = 0;

static void Thread_1()
{
    y = 1; // Store y
    r1 = x; // Load X
}

static void Thread_2()
{
    x = 1; // Store x
    r2 = y; // Load y
}

static void Main(string[] args)
{
    int count = 0;
    while (true)
    {
        count++;
        x = y = r1 = r2 = 0;

        Task t1 = new Task(Thread_1);
        Task t2 = new Task(Thread_2);
        t1.Start();
        t2.Start();

        Task.WaitAll(t1, t2);

        if (r1 == 0 && r2 == 0)
            break;
    }

    Console.WriteLine($"{count}ë²ˆ ë§Œì— ë¹ ì ¸ë‚˜ì˜´");
}
```

ìˆ˜í•™ì ìœ¼ë¡œëŠ” ë¹ ì ¸ë‚˜ì˜¬ìˆ˜ì—†ì§€ë§Œ í•˜ë“œì›¨ì–´ ìµœì í™”ë¡œ ì¸í•´ ì½”ë“œ ì¬ë°°ì¹˜ ë°œìƒ

```cs
static void Thread_1()
{
    r1 = x; // Load X
    y = 1; // Store y
}
```

ì´ë ‡ê²Œ ë³€í™˜ë˜ì–´ ë¹ ì ¸ë‚˜ì˜¨ë‹¤


### ğŸªë©”ëª¨ë¦¬ ë² ë¦¬ì–´ë¡œ ë§‰ê¸°

* ì½”ë“œì¬ë°°ì¹˜ ë§‰ê¸°
  * ì½”ë“œ ì¬ë°°ì¹˜ë¥¼ ë§‰ê¸°ìœ„í•œ ì„ ì„ ë§Œë“ ë‹¤!
  * Thread.MomoryBarrierì‚¬ìš©

* MemoryBarrier
  * 1) Full Memory Barrier (ASM MFENCE, C# Thread.MenoryBarrier) : Store/Load ë‘˜ ë‹¤ ë§‰ëŠ”ë‹¤
  * 2) Store Memory Barrier (ASM SFENCE) : Storeë§Œ ë§‰ëŠ”ë‹¤
  * 3) Load Memory Barrier (ASM LFENCE) : Loadë§Œ ë§‰ëŠ”ë‹¤

```cs
static void Thread_1()
{
    y = 1; // Store y

    // -----------------------
    Thread.MemoryBarrier(); // ìœ„ì•„ë˜ ì½”ë“œ ì´ë™ ë¶ˆê°€

    r1 = x; // Load X
}

static void Thread_2()
{
    x = 1; // Store x

    // -----------------------
    Thread.MemoryBarrier();

    r2 = y; // Load y
}
```

### ğŸªê°€ì‹œì„±ì˜ ì—­í• 

* ë©”ëª¨ë¦¬ ë² ë¦¬ì–´ëŠ” ê°€ì‹œì„±ì˜ ì—­í• ë„ í•œë‹¤

* ê°€ì‹œì„± ì‹ë‹¹ ë¹„ìœ 
  * A ì§ì›ì´ ì½œë¼ ì£¼ë¬¸ì„ ë°›ëŠ”ë‹¤
  * A ì§ì›ì´ ì£¼ë¬¸í˜„í™©ì— ì˜¬ë¦°ë‹¤
  * B ì§ì›ì€ ì£¼ë¬¸í˜„í™©ì„ ë³´ê³  ìˆ˜ì²©ì„ ê°±ì‹ í•œë‹¤

* ê°€ì‹œì„± í™”ì¥ì‹¤ ë¹„ìœ 
  * í™”ì¥ì‹¤ì„ ì‚¬ìš©í•˜ê³  ë‚œ ë’¤ ë¬¼ì„ ë‚´ë¦°ë‹¤
  * ë‹¤ìŒìœ¼ë¡œ í™”ì¥ì‹¤ì„ ì‚¬ìš©í•˜ëŠ” ì‚¬ëŒì€ ë¬¼ì„ ë‚´ë¦¬ê³  ì‚¬ìš©í•œë‹¤

A ì“°ë ˆë“œëŠ” ìºì‹œì— ë‚´ìš©ì„ ì ê³  ë¨ì— ë™ê¸°í™”ë¥¼ í•¨

B ì“°ë ˆë“œëŠ” ë™ê¸°í™”ë¥¼ í•˜ê³  ìºì‹œì˜ ë‚´ìš©ì„ ê°±ì‹ í•¨

```cs
static void Thread_1()
{
    y = 1; // Store y

    // -----------------------
    Thread.MemoryBarrier(); // ë¬¼ë‚´ë¦¬ê¸° (ì •ë³´ ë™ê¸°í™”)

    r1 = x; // Load X
}

static void Thread_2()
{
    x = 1; // Store x

    // -----------------------
    Thread.MemoryBarrier(); // ë¬¼ë‚´ë¦¬ê¸° (ì •ë³´ ë™ê¸°í™”)

    r2 = y; // Load y
}
```

* ë©”ëª¨ë¦¬ ë² ë¦¬ì–´ ì˜ˆì‹œ

```cs
int _answer;
bool _complete;

void A()
{
    _answer = 123; // store
    Thread.MemoryBarrier(); // Barrier 1 ì •ë³´ë¥¼ ì €ì¥í•˜ê³  ë™ê¸°í™”
    _complete = true; // store
    Thread.MemoryBarrier(); // Barrier 2 ì •ë³´ë¥¼ ì €ì¥í•˜ê³  ë™ê¸°í™”
}

void B()
{
    Thread.MemoryBarrier(); // Barrier 3 ì •ë³´ë¥¼ ì½ê¸°ì „ ë™ê¸°í™”
    if (_complete) // read
    {
        Thread.MemoryBarrier(); // Barrier 4 ì •ë³´ë¥¼ ì½ê¸°ì „ ë™ê¸°í™”
        Console.WriteLine(_answer); // read
    }
}
```





